Title: 쿼리 성능 측정은 어떻게 하는 것이 옳을까?
Time: 21:05:00

예전에 '쿼리 성능 측정을 방해하는 요소를 제거하기'를 주제로 블로그에 글을 쓴 적이 있다.

참고 :[http://blog.naver.com/ez_/140113578383](http://blog.naver.com/ez_/1401135
78383)

  

글을 쓴 지는 시간이 좀 지났지만, 최근에 트위터와 페이스북을 통해 여러 고수분들을 온라인으로나마 뵐 수 있게 되어, 이 글에 대한 의견을
여쭤보았다.

트위터에서 멘션으로 오간 내용 중에 나누면 의미있을 내용이 많은 듯 하여, 그 내용을 시간순으로 정리해보았다.

  

Actor

[@charsyam](http://twitter.com/charsyam)

[@gywndi](http://twitter.com/gywndi)

[@mimul](http://twitter.com/mimul)

[@lqez](http://twitter.com/lqez)

  

  

Timeline

  

lqez

제대로 된 쿼리 성능 측정을 위해서는 커널 / 디스크 레벨에서의 캐시까지 없애는 작업이 필요하지 않을까?

이미 달궈진 - 캐시가 확보된 - 시스템에서의 성능 측정은 덜 일반적인 경우가 아닌 것 같다.

  

gywndi

데이터베이스가 충분히 워밍업 되지 않은 상태에서는 디스크의 영향이 제일 클 것 같다.

키캐시와 버퍼풀 등을 달군 후에 측정하는 것이 좋을 것 같다.

  

charsyam

대규모 트래픽에서는 기본적인 성능 확보를 위해 서비스 투입시 DB캐시, 캐시 솔루션 등을 모두 웜 업 하는 시간을 가진다.

그러므로 테스트에서도 달군 후에 측정하는 것이 실제 성능과 유사하므로,워밍업 후에 측정하는 것이 좋을 것 같다.

그리고 아래의 간단한 명령어로 전체 OS 캐시를 제거할 수 있다.

> echo 3 > /proc/sys/vm/drop_caches

lqez

실전에서의 성능을 테스트하기 위한 것이라면 달구는 작업이 필요할 것 같다.

하지만 A쿼리와 B쿼리 또는 A설정과 B설정의 비교를 위해서라면 모두 배제해야하는 것 아닐까?

  

charsyam

데이터베이스의 성능에 대해서는 EXPLAIN - 실행 계획으로 비교하는 것이 더 옳지 않은가?

도리어 상상해보면, 실행 위치에서의 디스크 암 위치에 따라 결과가 바뀔 수도 있다.

  

gywndi

쿼리 캐시는 끄는 것이 옳겠지만, 나머지 요소는 결과에 큰 영향이 없을 것 같다.주된 성능 저해 요소는 디스크다.

  

mimul

서버 커널레벨에서 malloc, 디스크 튜닝 포인트를 제거하면 데이터베이스 자체의 성능에 집중할 수 있다.

게다가 테스트 환경의 객관성 확보가 어려우므로, 데이터베이스 서버의 운영 환경과 데이터의 종료 등을 종합적으로 고려해 최선의 성능을 측정하는
것이 중요하다.

  

lqez

객관성 확보가 어렵다는 의견에 동의한다. 시장에서 받아들일 수 있는 '객관성 수준' 선택이 필요한 것 같다.

  

charsyam

그래서 실제 데이터를 복제 한 뒤, 서비스에서 나오는 평균 속도로 벤치마크를 진행하였다.

  

gywndi

데이터베이스 성능 측정에서 NIC를 통하는지 혹은 로컬 소켓을 통하는지 여부에 따라서도 큰 영향이 있다.

기준점을 명확히 결정하고 성능 변화를 측정하는 것이 중요하다.

평균 속도 측정에 동의한다. 마찬가지로 재부팅 5-10분 후 평균치를 결과값으로 측정한다.

  

charsyam

엄밀하게는 평균 속도를 측정하는 구간이 있고, 실제로는 90%가 커버되는 속도 구간을 나눠서 측정했다.

서비스 지표상으로는 후자가 더 중요한 의미를 가진다.

  

  

  

Epilogue

  

벤치마크나 쿼리의 성능 측정을 하는 목적이 무엇인가?

테스트 환경에서 미리 돌려보고 서비스 환경에서 어떻게 돌아갈 지 예측하는 과정이 아니던가?

1회 쿼리의 성능에 대해서는 charsyam님 말씀과 같이 실행 계획으로 확인할 수 있다.

충분한 모수를 가지고 물리적 장치를 구동시켜 비교해야하는 것이 마땅하다.

  

따라서, 애초에 디스크 / 커널 레벨 캐시를 날려가면서까지 측정할 이유는 없었던 것 같다.

단순히 걸린 시간을 정확하게 재는 것이 아닌, 더 실용적인 벤치마크가 옳은 벤치마크라고 생각한다.

  

